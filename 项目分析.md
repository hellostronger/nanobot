# nanobot 项目分析

## 项目概述

**nanobot** 是一个超轻量级个人 AI 助手框架，代码约 4,000 行。设计目标是**研究导向**和**易于修改**，提供简洁的 Agent 框架，支持多种 LLM 提供商和聊天渠道。

### 核心功能

- **多模型接入**：OpenRouter、Anthropic、OpenAI、Groq、 Gemini、vLLM、Amazon Bedrock
- **多渠道支持**：Telegram、WhatsApp、CLI 交互
- **工具系统**：内置工具 + 可扩展子 agent（Skills）
- **任务调度**：定时任务（Cron）和心跳服务（Heartbeat）

---

## 项目入口

### 入口点

| 文件 | 作用 |
|------|------|
| `nanobot/__main__.py` | 模块入口：`python -m nanobot` |
| `nanobot/cli/commands.py` | CLI 命令定义（使用 Typer） |

### CLI 命令

| 命令 | 用法 |
|------|------|
| `nanobot agent` | 交互式对话 |
| `nanobot agent -m "问题"` | 单次提问 |
| `nanobot gateway` | 启动服务（接收 Telegram/WhatsApp 消息） |
| `nanobot onboard` | 初始化配置和workspace |
| `nanobot status` | 查看状态 |
| `nanobot channels status` | 查看渠道状态 |
| `nanobot channels login` | WhatsApp 扫码登录 |
| `nanobot cron add --name "任务" --message "内容" --cron "0 9 * * *"` | 添加定时任务 |
| `nanobot cron list` | 查看定时任务列表 |

---

## 目录结构

```
nanobot/
├── agent/           # 核心 Agent 循环
│   ├── loop.py      # AgentLoop 主循环，处理 LLM 调用和工具执行
│   ├── context.py   # 上下文管理
│   ├── memory.py    # 记忆管理
│   ├── skills.py    # Skills 加载器
│   ├── subagent.py  # 子 agent 管理
│   └── tools/       # 内置工具
│       ├── base.py          # Tool 基类
│       ├── registry.py      # 工具注册表
│       ├── filesystem.py    # 文件系统操作
│       ├── message.py       # 消息发送
│       ├── shell.py         # Shell 命令执行
│       ├── spawn.py         # 创建子 agent
│       └── web.py           # Web 搜索/请求
│
├── bus/             # 消息总线（发布-订阅模式）
│   ├── queue.py     # MessageBus 异步队列实现
│   └── events.py    # 事件类型定义（InboundMessage, OutboundMessage）
│
├── channels/        # 聊天渠道集成
│   ├── base.py      # BaseChannel 基类
│   ├── manager.py   # ChannelManager 管理和路由
│   ├── telegram.py  # Telegram 实现
│   └── whatsapp.py  # WhatsApp 实现（通过 bridge/）
│
├── cli/             # 命令行界面
│   └── commands.py  # Typer 命令定义
│
├── config/          # 配置管理
│   ├── schema.py    # Config 数据模型（Pydantic）
│   └── loader.py    # 配置加载/保存
│
├── cron/            # 定时任务服务
│   ├── service.py   # CronService 实现
│   └── types.py     # CronJob 类型定义
│
├── heartbeat/       # 心跳服务
│   └── service.py   # HeartbeatService，每 30 分钟唤醒 Agent
│
├── providers/       # LLM 提供商
│   ├── base.py      # Provider 基类
│   ├── litellm_provider.py  # LiteLLM 封装（统一多模型接口）
│   └── transcription.py     # 语音转文字
│
├── session/         # 会话管理
│   └── manager.py   # SessionManager 对话历史管理
│
└── utils/           # 工具函数
    └── helpers.py   # 辅助函数（路径等）
```

---

## 架构设计

### 总线架构

```
用户 → Channel → MessageBus → AgentLoop → LLM/工具
                            ↓
                    CronService/HeartbeatService
```

### 消息流程

1. **入站**：Telegram/WhatsApp 收到消息 → `publish_inbound()` → Agent 消费
2. **处理**：AgentLoop 调用 LLM → 执行工具 → 生成响应
3. **出站**：响应 → `publish_outbound()` → Channel 发送

### MessageBus 核心方法

| 方法 | 作用 |
|------|------|
| `publish_inbound(msg)` | 发布入站消息 |
| `consume_inbound()` | 消费入站消息（阻塞） |
| `publish_outbound(msg)` | 发布出站消息 |
| `consume_outbound()` | 消费出站消息（阻塞） |
| `subscribe_outbound(channel, callback)` | 订阅通道出站消息 |
| `dispatch_outbound()` | 调度出站消息到订阅者 |

---

## 配置与工作区

### 配置文件

路径：`~/.nanobot/config.json`

```json
{
  "providers": {
    "openrouter": { "apiKey": "..." },
    "anthropic": { "apiKey": "..." }
  },
  "agents": {
    "defaults": { "model": "anthropic/claude-opus-4-5" }
  },
  "channels": {
    "telegram": { "enabled": true, "token": "..." },
    "whatsapp": { "enabled": true, "bridge_url": "..." }
  }
}
```

### Workspace 文件

路径：`~/.nanobot/workspace/`

| 文件 | 作用 |
|------|------|
| `AGENTS.md` | Agent 行为指令 |
| `SOUL.md` | 个性与身份设定 |
| `USER.md` | 用户信息与偏好 |
| `memory/MEMORY.md` | 长期记忆（跨会话持久化） |

---

## 工具系统

### 内置工具

| 工具 | 功能 |
|------|------|
| `filesystem` | 读取/写入/列出文件 |
| `shell` | 执行 Shell 命令 |
| `spawn` | 创建子 agent（通过 Skills） |
| `message` | 发送消息到渠道 |
| `web_search` | Brave Web 搜索 |
| `http_request` | HTTP 请求 |

### 添加新工具

1. 在 `nanobot/agent/tools/` 创建类，继承 `Tool`
2. 实现接口方法
3. 在 `AgentLoop._register_default_tools()` 注册

---

## Skills 系统

Skills 是子 agent 定义，存储在 `nanobot/skills/` 目录。

每个 Skill 包含：
- `SKILL.md` - 描述用途和行为
- 辅助文件（可选）

通过 `spawn` 工具加载。

---

## 依赖技术

| 技术 | 用途 |
|------|------|
| **Typer** | CLI 命令行界面 |
| **Rich** | 格式化输出 |
| **LiteLLM** | 多模型统一封装 |
| **Pydantic** | 配置和数据验证 |
| **Loguru** | 日志记录 |
| **Asyncio** | 异步编程 |
| **WhatsApp Bridge** | Node.js WhatsApp 集成 |
